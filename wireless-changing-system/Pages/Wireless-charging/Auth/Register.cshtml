@page
@model wireless_changing_system.Pages.Wireless_charging.Auth.RegisterModel
@{
}
<style>
    input[type="password"]::-ms-reveal,
    input[type="password"]::-ms-clear {
        display: none;
    }

    .invalid-field {
        border: 1px solid #dc3545 !important;
    }

    .image-preview {
        border: 2px dashed #ddd;
        border-radius: 8px;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        padding: 10px;
        background-color: #f8f9fa;
    }

    .preview-image {
        display: block !important;
        max-width: 100%;
        max-height: 180px;
        border: 1px solid #ddd;
        padding: 5px;
    }

    .preview-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        background: #dc3545;
        color: white;
        border: none;
    }

    .preview-text {
        color: #6c757d;
        font-style: italic;
    }
</style>
<div class="container d-flex flex-column justify-content-center align-items-center min-vh-100">
    <img src="~/img/logo.png" alt="Logo" class="mb-4 hide-mobile" style="max-width: 120px" />
    <div class="card p-4 shadow mobi-margin-top" style="max-width: 800px; width: 100%;">
        <h2 class="text-center mb-4">Tạo tài khoản mới</h2>
        <form id="registerForm" method="post" enctype="multipart/form-data">
            <div class="row">
                <div class="col-md-6 pe-md-3">
                    <div class="mb-3">
                        <label for="fullname" class="form-label fw-semibold">Họ và tên</label>
                        <input type="text" class="form-control" id="fullname" name="Fullname" placeholder="Họ và tên" required />
                    </div>
                    <div class="mb-3">
                        <label for="dob" class="form-label fw-semibold">Ngày sinh</label>
                        <input type="date" class="form-control" id="dob" name="Dob" required />
                    </div>
                    <div class="mb-3">
                        <label for="cccd" class="form-label fw-semibold">Số CCCD</label>
                        <input type="text" class="form-control" id="cccd" name="CccdCode" placeholder="Nhập số CCCD" minlength="9" maxlength="12" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Giới tính:</label>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="Gender" id="male" value="true" required />
                                <label class="form-check-label" for="male">Nam</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="Gender" id="female" value="false" />
                                <label class="form-check-label" for="female">Nữ</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label fw-semibold">Địa chỉ</label>
                        <input type="text" class="form-control" id="address" name="Address" placeholder="Nhập địa chỉ" required />
                    </div>
                    <div class="mb-3">
                        <label for="cccdFront" class="form-label fw-semibold">Ảnh mặt trước CCCD</label>
                        <input type="file" class="form-control" id="cccdFront" name="CCCDFrontImage" accept="image/*" required />
                        <div class="image-preview mt-2" id="cccdFrontPreview">
                            <div class="preview-text">Chưa có ảnh được chọn</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="cccdBack" class="form-label fw-semibold">Ảnh mặt sau CCCD</label>
                        <input type="file" class="form-control" id="cccdBack" name="CCCDBackImage" accept="image/*" required />
                        <div class="image-preview mt-2" id="cccdBackPreview">
                            <div class="preview-text">Chưa có ảnh được chọn</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 ps-md-3">
                    <div class="mb-3">
                        <label for="phone" class="form-label fw-semibold">Số điện thoại</label>
                        <input type="tel" class="form-control" id="phone" name="PhoneNumber" placeholder="Nhập số điện thoại" required />
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label fw-semibold">Email</label>
                        <input type="email" class="form-control" id="email" name="Email" placeholder="Nhập địa chỉ email" required />
                    </div>
                    <div class="mb-3 position-relative">
                        <label for="password" class="form-label fw-semibold">Mật khẩu</label>
                        <input type="password" class="form-control pe-5" id="password" name="PasswordHash" placeholder="Nhập mật khẩu" required />
                        <i class="bi bi-eye-slash toggle-password" style="position: absolute; right: 15px; bottom: 10px; cursor: pointer;"></i>
                    </div>
                    <div id="password-rules-wrapper" style="display:none;">
                        <ul class="password-rules-list">
                            <li id="rule-length"><i class="bi bi-x-circle rule-icon"></i> Ít nhất 6 ký tự</li>
                            <li id="rule-uppercase"><i class="bi bi-x-circle rule-icon"></i> Ít nhất 1 chữ hoa</li>
                            <li id="rule-number"><i class="bi bi-x-circle rule-icon"></i> Ít nhất 1 chữ số</li>
                            <li id="rule-special"><i class="bi bi-x-circle rule-icon"></i> Ít nhất 1 ký tự đặc biệt</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="agreeTerms" required />
                <label class="form-check-label" for="agreeTerms">Tôi đồng ý với <a href="#" class="text-decoration-none">điều khoản dịch vụ</a></label>
            </div>
            <button type="submit" id="regisBtn" class="btn btn-primary w-100 mb-3 fw-semibold" disabled>Đăng ký</button>
            <div class="text-center">
                <a href="/wireless-charging/auth" class="text-decoration-none">Đã có tài khoản? Đăng nhập tại đây</a>
            </div>
        </form>
    </div>
</div>
<div id="error-toast" class="custom-toast">
    <div class="toast-progress"></div>
    <i class="bi bi-exclamation-circle-fill toast-icon"></i>
    <div class="toast-content"><strong>Lỗi!</strong><p class="mb-0"></p></div>
</div>
<div id="success-toast" class="custom-toast success-toast">
    <div class="toast-progress"></div>
    <i class="bi bi-check-circle-fill toast-icon"></i>
    <div class="toast-content"><strong>Thành công!</strong><p class="mb-0"></p></div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', ()=>{
        let validCCCDFront=false;
        let validCCCDBack=false;
        let allValid=false;
        const regisBtn=document.getElementById('regisBtn');
        const agreeCheckbox=document.getElementById('agreeTerms');

        const updateSubmitState=()=>{
            regisBtn.disabled=!(allValid&&validCCCDFront&&validCCCDBack&&agreeCheckbox.checked);
        };

        agreeCheckbox.addEventListener('change',updateSubmitState);

        // Image preview and QR scan
        ['Front','Back'].forEach(side=>{
            const input=document.getElementById(`cccd${side}`);
            const previewId=`cccd${side}Preview`;
            input.addEventListener('change',async function(){
                previewImage(this,previewId);
                if(side==='Front'&&this.files[0]){
                    try{
                        const formData=new FormData();formData.append('file',this.files[0]);
                        const res=await fetch('https://localhost:7191/api/Images/read-qr',{
                            method:'POST',
                            headers:{'Accept':'text/plain'},
                            body:formData
                    });
                        const data=await res.json();
                        if(!res.ok) throw new Error(data.detail||'Lỗi đọc ảnh CCCD');
                        const parts=data.result.split('|');
                        if(parts.length>=6){
                            document.getElementById('cccd').value=parts[0].trim();
                            document.getElementById('fullname').value=parts[2].trim();
                            const d=parts[3].trim();
                            document.getElementById('dob').value=`${d.slice(4)}-${d.slice(2,4)}-${d.slice(0,2)}`;
                            const g=parts[4].trim().toLowerCase();
                            document.getElementById(g==='nam'?'male':'female').checked=true;
                            document.getElementById('address').value=parts[5].trim();
                            validCCCDFront=true;
                        }
                    }catch(err){
                        showToast(err.message==='Không tìm thấy QR code trong ảnh'? 'Không đọc được CCCD, vui lòng gửi lại ảnh':err.message);
                        validCCCDFront=false;
                    }
                } else if(side==='Back'){
                    validCCCDBack=!!this.files[0];
                }
                updateSubmitState();
            });
        });

        // Generic preview
        function previewImage(input,previewId){
            const preview=document.getElementById(previewId);
            const file=input.files[0];
            preview.innerHTML=file?'<div style="position:relative;"></div>':'<div class="preview-text">Chưa có ảnh được chọn</div>';
            if(file){
                const reader=new FileReader();
                reader.onload=e=>{
                    const wrapper=document.createElement('div');
                    wrapper.style.position='relative';
                    const img=document.createElement('img');
                    img.src=e.target.result;
                    img.classList.add('preview-image');
                    const btn=document.createElement('button');
                    btn.className='preview-remove';btn.textContent='×';
                    btn.onclick=()=>{
                      input.value='';
                    preview.innerHTML='<div class="preview-text">Chưa có ảnh được chọn</div>';
                    if(previewId.includes('Front'))
                    {
                        validCCCDFront=false;
                    }
                    else {
                        validCCCDBack=false;
                        updateSubmitState();
                    }
                    };
                    wrapper.append(img,btn);
                    preview.innerHTML='';
                    preview.append(wrapper);
                };
                reader.readAsDataURL(file);
            }
        }

        // Toggle password visibility
        document.querySelector('.toggle-password').addEventListener('click',function(){
            const pw=document.getElementById('password');
            const type=pw.type==='password'?'text':'password';
            pw.type=type;
            this.classList.toggle('bi-eye-slash');
            this.classList.toggle('bi-eye');
        });

        // Password rules
        document.getElementById('password').addEventListener('input',function(){
            const pw=this.value;
            document.getElementById('password-rules-wrapper').style.display=pw?'block':'none';
            const rules=[pw.length>=6,/[^a-z]/i.test(pw),/\d/.test(pw),/[!@@#$%^&*(),.?":{}|<>]/.test(pw)];
            ['rule-length','rule-uppercase','rule-number','rule-special'].forEach((id,i)=>{
                const el=document.getElementById(id),icon=el.querySelector('.rule-icon');
                if(rules[i]){
                icon.classList.replace('bi-x-circle','bi-check-circle');
                el.classList.add('valid');
                } else {
                    icon.classList.replace('bi-check-circle','bi-x-circle');
                    el.classList.remove('valid');
                }
            });
            allValid=rules.every(Boolean);
            updateSubmitState();
        });

        // Phone and Email blur validation
        document.getElementById('phone').addEventListener('blur',function(){
            if(this.value&& !validatePhone(this.value)) this.classList.add('invalid-field'); else this.classList.remove('invalid-field');
        });
        document.getElementById('email').addEventListener('blur',function(){
            if(this.value&& !validateEmail(this.value)){ 
                showToast('Email không hợp lệ');
                this.classList.add('invalid-field');
            } else this.classList.remove('invalid-field');
        });

        // Form submission
        document.getElementById('registerForm').addEventListener('submit',async function(e){
            e.preventDefault();
            if(!(allValid&&validCCCDFront&&validCCCDBack)) return;
            regisBtn.disabled=true; regisBtn.innerHTML='<span class="spinner-border spinner-border-sm"></span> Đang xử lý...';
            try{
                const formData=new FormData(this);
                const res=await fetch('https://localhost:7191/api/auth/register',{
                    method:'POST',
                    body:formData
                });
                const data=await res.json();
                if(!res.ok) {
                    throw new Error(data.detail||'Đăng ký thất bại');
                }
                await sendActivateEmail(document.getElementById('email').value);
                showSuccessToast('Đăng ký thành công!');
                setTimeout(()=>location.href='./',2000);
            }catch(err){
                showToast(err.message);
            }finally{
                regisBtn.disabled=false;
                regisBtn.textContent='Đăng ký';
            }
        });
        async function sendActivateEmail(email) {
            try {
                const res = await fetch('https://localhost:7191/api/otp/activation-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Email: email })
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.detail||'Gửi email kích hoạt thất bại');
            } catch (error) {
                showToast(error.message);
            }
        }
        // Utility validators
        function validateEmail(email){ return /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/.test(email);}
        function validatePhone(phone){
            let p=phone.startsWith('+84')?'0'+phone.slice(3):phone;
            if(p.length!==10) {
                showToast('Số điện thoại phải có 10 chữ số');
                return false;
            }
            return /^(0)(3[2-9]|5[2689]|7[06789]|8[1-9]|9\d|2[0-9])\d{7}$/.test(p)|| (showToast('Số điện thoại không hợp lệ'),false);
        }
        function showSuccessToast(msg){
            const t=document.getElementById('success-toast');
            t.querySelector('.toast-content p').textContent=msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'),5000);
        }
        function showToast(msg){
            const t=document.getElementById('error-toast');
            t.querySelector('.toast-content p').textContent=msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'),5000);
        }
    });
</script>
