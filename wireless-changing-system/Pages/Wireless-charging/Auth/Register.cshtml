@page
@model wireless_changing_system.Pages.Wireless_charging.Auth.RegisterModel
@{
}
<style>
     input[type="password"]::-ms-reveal,
     input[type="password"]::-ms-clear {
         display: none;
     }
</style>
<div class="container d-flex flex-column justify-content-center align-items-center min-vh-100">
    <img src="~/img/logo.png" alt="Logo" class="mb-4 hide-mobile" style="max-width: 120px" />

    <div class="card p-4 shadow mobi-margin-top" style="max-width: 800px; width: 100%;">
        <h2 class="text-center mb-4">Create a new account</h2>
        <form id="registerForm" method="post" enctype="multipart/form-data">
            <div class="row">
                <div class="col-md-6 pe-md-3" style="margin:0px">
                    <div class="mb-3">
                        <label for="fullname" class="form-label fw-semibold">Họ và tên</label>
                        <input type="text"
                               class="form-control"
                               id="fullname"
                               name="Fullname"
                               placeholder="Full Name"
                               readonly
                               required>
                    </div>

                    <div class="mb-3">
                        <label for="dob" class="form-label fw-semibold">Ngày sinh</label>
                        <input type="date"
                               class="form-control"
                               id="dob"
                               name="Dob"
                               readonly
                               required>
                    </div>
                    <div class="mb-3">
                        <label for="cccd" class="form-label fw-semibold">CCCD Code</label>
                        <input type="text"
                               class="form-control"
                               id="cccd"
                               name="CccdCode"
                               placeholder="CCCD Code"
                               minlength="9"
                               maxlength="12"
                               readonly
                               required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Gender:</label>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="Gender"
                                       id="male"
                                       value="true"
                                       required
                                       readonly>
                                <label class="form-check-label" for="male">Nam</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="Gender"
                                       id="female"
                                       value="false"
                                       readonly>
                                <label class="form-check-label" for="female">Nữ</label>
                            </div>
                        </div>
                    </div>



                    <!-- Address -->
                    <div class="mb-3">
                        <label for="address" class="form-label fw-semibold">Address</label>
                        <input type="text"
                               class="form-control"
                               id="address"
                               name="Address"
                               placeholder="Address"
                               required>
                    </div>
                    <!-- CCCD Front Image -->
                    <div class="mb-3">
                        <label for="cccdFront" class="form-label fw-semibold">CCCD Front Image</label>
                        <input type="file"
                               class="form-control"
                               id="cccdFront"
                               name="CCCDFrontImage"
                               accept="image/*"
                               required
                               onchange="previewImage(this, 'cccdFrontPreview')">
                        <img id="cccdFrontPreview" class="mt-2" style="max-width: 100%; max-height: 150px; display: none;" />
                    </div>

                    <div class="mb-3">
                        <label for="cccdBack" class="form-label fw-semibold">CCCD Back Image</label>
                        <input type="file"
                               class="form-control"
                               id="cccdBack"
                               name="CCCDBackImage"
                               accept="image/*"
                               required
                               onchange="previewImage(this, 'cccdBackPreview')">
                        <img id="cccdBackPreview" class="mt-2" style="max-width: 100%; max-height: 150px; display: none;" />
                    </div>
                </div>

                <div class="col-md-6 ps-md-3">
                    <div class="mb-3">
                        <label for="phone" class="form-label fw-semibold">Phone Number</label>
                        <input type="tel"
                               class="form-control"
                               id="phone"
                               name="PhoneNumber"
                               placeholder="Phone Number"
                               required>
                    </div>


                    <!-- Email -->
                    <div class="mb-3">
                        <label for="email" class="form-label fw-semibold">Email</label>
                        <input type="email"
                               class="form-control"
                               id="email"
                               name="Email"
                               placeholder="Email"
                               required>
                    </div>
                    <!-- Trường mật khẩu với nút hiển thị -->
                    <div class="mb-3 position-relative">
                        <label for="password" class="form-label fw-semibold">Mật khẩu</label>
                        <input type="password"
                               class="form-control pe-5"
                               id="password"
                               name="PasswordHash"
                               placeholder="Nhập mật khẩu"
                               required>
                        <i class="bi bi-eye-slash toggle-password"
                           style="position: absolute; right: 15px; bottom: 10px; cursor: pointer;"></i>
                    </div>

                    <div id="password-rules-wrapper" style="display: none;">
                        <ul id="password-rules" class="password-rules-list">
                            <li id="rule-length"><i class="bi bi-x-circle rule-icon"></i> Ít nhất 6 ký tự</li>
                            <li id="rule-uppercase"><i class="bi bi-x-circle rule-icon"></i> Ít nhất 1 chữ hoa</li>
                            <li id="rule-number"><i class="bi bi-x-circle rule-icon"></i> Ít nhất 1 chữ số</li>
                            <li id="rule-special"><i class="bi bi-x-circle rule-icon"></i> Ít nhất 1 ký tự đặc biệt</li>
                        </ul>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 mb-3 fw-semibold">
                Đăng ký
            </button>

            <div class="text-center">
                <a href="/login" class="text-decoration-none">
                    Đã có tài khoản? Đăng nhập tại đây
                </a>
            </div>
        </form>
    </div>
</div>
<script>
        // Thêm logic toggle password
    document.querySelector('.toggle-password').addEventListener('click', function(e) {
        const passwordInput = document.getElementById('password');
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        this.classList.toggle('bi-eye-slash');
        this.classList.toggle('bi-eye');
    });

    // Thêm validation password real-time
    document.getElementById('password').addEventListener('input', function(e) {
        const password = e.target.value;
        const rulesWrapper = document.getElementById('password-rules-wrapper');

        rulesWrapper.style.display = password.length > 0 ? 'block' : 'none';

        const isLengthValid = password.length >= 6;
        const hasUppercase = /[A-Z]/.test(password);
        const hasNumber = /\d/.test(password);
        const hasSpecial = /[!@@#$%^&*(),.?":{}|<>]/.test(password);

        updateRule('rule-length', isLengthValid);
        updateRule('rule-uppercase', hasUppercase);
        updateRule('rule-number', hasNumber);
        updateRule('rule-special', hasSpecial);
    });

    function updateRule(ruleId, isValid) {
        const ruleElement = document.getElementById(ruleId);
        const icon = ruleElement.querySelector('.rule-icon');

        if (isValid) {
            icon.classList.remove('bi-x-circle');
            icon.classList.add('bi-check-circle');
            ruleElement.classList.add('valid');
        } else {
            icon.classList.remove('bi-check-circle');
            icon.classList.add('bi-x-circle');
            ruleElement.classList.remove('valid');
        }
    }

    // Hàm preview ảnh
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.style.display = 'block';
                preview.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
            preview.src = '';
        }
    }

    // Khi chọn ảnh CCCD Front: preview và gọi API quét QR code
    document.getElementById("cccdFront").addEventListener("change", function() {
        const fileInput = this;
        const file = fileInput.files[0];
        if (!file) return;

        // Hiển thị preview
        previewImage(fileInput, 'cccdFrontPreview');

        // Tạo FormData và thêm file
        const formData = new FormData();
        formData.append("file", file);

        // Gọi API POST /read-qr để quét QR code
        fetch("https://localhost:7191/api/Images/read-qr", {
            method: "POST",
            body: formData
        })
        .then(response => response.ok ? response.text() : Promise.reject("Lỗi server"))
        .then(result => {
            if(result.trim() === "Không tìm thấy QR code") {
                alert("Không đọc được QR code, vui lòng gửi lại ảnh CCCD Front.");
                return;
            }

            const parts = result.split("|");
            if(parts.length >= 6) {
                document.getElementById("cccd").value = parts[0].trim();
                document.getElementById("fullname").value = parts[2].trim();

                // Chuyển định dạng ngày ddMMyyyy sang yyyy-MM-dd
                let dob = parts[3].trim();
                if(dob.length === 8) {
                    const day = dob.substring(0,2);
                    const month = dob.substring(2,4);
                    const year = dob.substring(4);
                    document.getElementById("dob").value = `${year}-${month}-${day}`;
                } else {
                    document.getElementById("dob").value = "";
                }

                const gender = parts[4].trim().toLowerCase();
                if(gender === "nam") {
                    document.getElementById("male").checked = true;
                } else if(gender === "nữ") {
                    document.getElementById("female").checked = true;
                }
                document.getElementById("address").value = parts[5].trim();
            } else {
                alert("Dữ liệu QR code không hợp lệ, vui lòng gửi lại ảnh CCCD Front.");
            }
        })
        .catch(error => {
            console.error(error);
            alert("Lỗi khi đọc QR code, vui lòng gửi lại ảnh CCCD Front.");
        });
    });

    document.getElementById("registerForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);

        fetch("https://localhost:7191/api/auth/register", {
            method: "POST",
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => Promise.reject(errorData));
            }
            return response.text();
        })
        .then(result => {
            alert(result);
            window.location.href = "/wireless-charging/auth";
        })
        .catch(error => {
            console.error(error);
            alert("Đăng ký thất bại: " + (error.Error || "Lỗi không xác định"));
        });
    });
</script>
