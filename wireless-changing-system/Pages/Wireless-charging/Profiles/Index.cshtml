@page
@model wireless_changing_system.Pages.Wireless_charging.Profiles.IndexModel
@{
}
    <div class="container d-flex justify-content-center align-items-center">
        <div class="row w-100 mt-3">
        <h3>Thông tin người dùng</h3>
            <div class="col-md-8 profile-content">
                <button class="btn btn-primary mb-3" id="change-password-btn">Đổi mật khẩu</button>

                <!--<div class="form-group">
                    <img alt="User profile picture" class="profile-img" height="100" src="https://placehold.co/100x100" width="100" id="profile-img" />
                </div>-->
                <div class="form-group">
                    <label for="fullname">Họ tên:</label>
                    <input class="form-control" id="fullname" type="text" />
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input class="form-control" id="email" type="text" />
                </div>
                <div class="form-group">
                    <label for="phone">Số điện thoại:</label>
                    <input class="form-control" id="phone" type="text" />
                </div>
                <div class="form-group">
                    <label for="cccd">
                        Số CCCD:
                        <span id="toggle-cccd" class="toggle-cccd ms-1">
                            
                                <i class="bi bi-eye"></i>

                        
                        </span>
                    </label>
                    <input class="form-control" id="cccd" type="text" readonly/>
                    <div class="img-cccd d-none mt-2">
                        <img id="imgFront" class="img-thumbnail mb-2" width="250" />
                        <img id="imgBack" class="img-thumbnail" width="250" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="dob">Ngày sinh:</label>
                    <input type="date" class="form-control" id="dob" />
                </div>
                <div class="form-group">
                    <label>Giới tính:</label>
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-radio" name="gender" type="radio" value="true" />
                            <span>Nam</span>
                        </label>
                        <label class="form-check-label">
                            <input class="form-radio" name="gender" type="radio" value="false" />
                            <span>Nữ</span>
                        </label>
                    </div>
                </div>
                <div class="form-group mb-2">
                    <label for="address">Địa chỉ:</label>
                    <input type="text" class="form-control" id="address" />
                </div>
                <div class="text-center">
                    <button id="save-btn" class="btn btn-primary">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Thông báo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Cập nhật thông tin thành công!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const userId = sessionStorage.getItem("userId");
            if (!userId) {
                alert("User chưa đăng nhập!");
                return;
            }
                    document.getElementById("change-password-btn").addEventListener("click", function () {
            window.location.href = "https://localhost:5216/wireless-charging/profiles/changepassword";
        });

            fetch(`https://localhost:7191/api/Auth/profile/${userId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("fullname").value = data.fullname;
                    document.getElementById("email").value = data.email;
                    document.getElementById("phone").value = data.phoneNumber;
                    document.getElementById("cccd").value = data.code;
                    document.getElementById("dob").value = data.dob.split("T")[0];
                    document.getElementById("address").value = data.address;
                   // document.getElementById("profile-img").src = data.imgFront;

                    // Giới tính
                    document.querySelector(`input[name="gender"][value="${data.gender}"]`).checked = true;

                    // Hình ảnh CCCD
                    document.getElementById("imgFront").src = data.imgFront;
                    document.getElementById("imgBack").src = data.imgBack;
                })
                .catch(error => console.error("Error fetching profile data:", error));

            // Sự kiện click để ẩn/hiện ảnh CCCD và đổi icon
            document.getElementById("toggle-cccd").addEventListener("click", function () {
                const cccdImages = document.querySelector(".img-cccd");
                const icon = document.querySelector("#toggle-cccd i");

                cccdImages.classList.toggle("d-none");
                if (cccdImages.classList.contains("d-none")) {
                    icon.classList.remove("bi-eye-slash");
                    icon.classList.add("bi-eye");
                } else {
                    icon.classList.remove("bi-eye");
                    icon.classList.add("bi-eye-slash");
                }
            });
            //edit user
                    document.getElementById("save-btn").addEventListener("click", function () {
            const updatedData = {
                fullname: document.getElementById("fullname").value,
                email: document.getElementById("email").value,
                phoneNumber: document.getElementById("phone").value,
                dob: new Date(document.getElementById("dob").value).toISOString(),
                gender: document.querySelector('input[name="gender"]:checked').value === "true",
                address: document.getElementById("address").value
            };

            fetch(`https://localhost:7191/api/Auth/profile/${userId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Cập nhật thất bại");
                }
                return response.json();
            })
            .then(data => {
                // Hiển thị modal Bootstrap
                var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
            })
            .catch(error => {
                console.error("Lỗi cập nhật:", error);
                alert("Cập nhật thất bại, vui lòng thử lại!");
            });
        });

        });
    </script>
}


