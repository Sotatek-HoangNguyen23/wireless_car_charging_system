@page
@model wireless_changing_system.Pages.Wireless_charging.ChargingStation.AddStationModel
@{
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Station</title>
    <link rel="stylesheet" href="~/css/chargingstation/addstation.css">
</head>
<body>
    <div class="container">
        <h1 class="text-center my-4">Thêm trạm sạc</h1>
        <div class="form-container">
            <!-- Station Name và Owner -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="stationName" class="form-label fw-bolder">Tên trạm sạc</label>
                    <input type="text" class="form-control" id="stationName" placeholder="Nhập tên trạm sạc">
                </div>
                <div class="col-md-6">
                    <label for="owner" class="form-label fw-bolder">Chủ sở hữu</label>
                    <select class="form-select" id="owner">
                        <option selected disabled>Đang tải danh sách chủ sở hữu...</option>
                    </select>
                </div>
            </div>

            <!--Charging Location -->
            <div class="row">
                <h3 class="my-2">Vị trí trạm sạc</h3>
            </div>

            <!-- Station Address -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="stationAddress" class="form-label fw-bolder">Địa chỉ</label>
                    <div class="d-flex">
                        <input type="text" class="form-control mr-3" id="stationAddress" placeholder="Nhập địa chỉ">
                        <button class="btn btn-primary mt-2" style="white-space: nowrap;" id="searchAddress">Tìm địa chỉ</button>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
            <div id="map" style="height: 500px;"></div>
            <div class="d-flex align-items-center gap-3 flex-wrap mt-2">
                <div class="d-flex align-items-center gap-2">
                    <label for="longitude" class="form-label mb-0">Kinh độ:</label>
                    <input type="text" id="longitude" class="form-control" placeholder="Longitude" style="width: 150px;" />
                </div>

                <div class="d-flex align-items-center gap-2">
                    <label for="latitude" class="form-label mb-0">Vĩ độ:</label>
                    <input type="text" id="latitude" class="form-control" placeholder="Latitude" style="width: 150px;" />
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="description" class="form-label fw-bolder">Mô tả</label>
                    <textarea class="form-control" id="description" rows="3" placeholder="Nhập mô tả"></textarea>
                </div>
            </div>

            <!--Charging Point -->
            <div class="row">
                <h3 class="my-2">Điểm sạc</h3>
            </div>

            <!-- Total Points và Point Name -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="totalPoints" class="form-label fw-bolder">Tổng số điểm sạc</label>
                    <input type="number" class="form-control" id="totalPoints" placeholder="Nhập tổng số điểm sạc">
                </div>
                <div class="col-md-6 row">
                    <label for="pointName" class="form-label fw-bolder">Mã điểm sạc</label>
                    <input type="text" class="form-control" id="pointName" placeholder="VD: HCM, HN, P,...">
                    <p class="form-note">Tên điểm sạc sẽ có dạng: Mã điểm sạc + số thứ tự (VD: P-1, P2,...)</p>
                </div>
            </div>

            <!-- Description và Max Power -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="description" class="form-label fw-bolder">Mô tả điểm sạc sạc</label>
                    <textarea class="form-control" id="pointDescription" rows="3" placeholder="Mô tả"></textarea>
                </div>
                <div class="col-md-6">
                    <label for="maxPower" class="form-label fw-bolder">Công suất tối đa</label>
                    <input type="number" class="form-control" id="maxPower" placeholder="Nhập công suất tối đa">
                </div>
            </div>

            <!-- Nút Submit -->
            <div class="text-center">
                <button id="btn-submit" type="submit" class="btn btn-primary">Thêm điểm sạc</button>
                <button class="btn btn-danger">Hủy</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
        const defaultLat = 10.7769;
        const defaultLng = 106.7009;

        const map = L.map('map').setView([defaultLat, defaultLng], 14);

        // Sử dụng bản đồ từ OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Thêm marker kéo được
        const marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

        // Cập nhật tọa độ vào input khi kéo marker
        marker.on('dragend', function (e) {
            const { lat, lng } = e.target.getLatLng();
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
        });

        // Cho phép click vào bản đồ để đặt lại marker
        map.on('click', function (e) {
            marker.setLatLng(e.latlng);
            document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
            document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
        });

        // Xử lý khi nhấn nút Tìm địa chỉ
        document.getElementById('searchAddress').addEventListener('click', function () {
            const address = document.getElementById('stationAddress').value;
            if (!address) return;

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);

                        map.setView([lat, lon], 16); // Zoom tới địa chỉ
                        marker.setLatLng([lat, lon]);

                        // Gán vào input
                        document.getElementById('latitude').value = lat.toFixed(6);
                        document.getElementById('longitude').value = lon.toFixed(6);
                    } else {
                        showToast("Không tìm thấy địa chỉ.");
                    }
                })
                .catch(err => {
                    console.error(err);
                    showToast("Có lỗi xảy ra khi tìm địa chỉ.");
                });
        });

        $(document).ready(function () {
            $("#btn-submit").click(function () {
                const stationDto = {
                    stationName: $("#stationName").val(),
                    ownerId: parseInt($("#owner").val()),  // Ép kiểu về số
                    address: $("#stationAddress").val(),
                    longitude: parseFloat($("#longitude").val()),  // Ép kiểu về số
                    latitude: parseFloat($("#latitude").val()),  // Ép kiểu về số
                    description: $("#description").val(),
                    totalPoint: parseInt($("#totalPoints").val()),  // Ép kiểu về số
                    pointCode: $("#pointName").eq(0).val(),
                    pointDescription: $("#pointDescription").val(),
                    maxPower: parseFloat($("#maxPower").val()) || 0 // Ép kiểu về số, mặc định 0 nếu null
                };

                console.log("Dữ liệu gửi đi:", stationDto); // Kiểm tra JSON trước khi gửi

                $.ajax({
                    url: "https://localhost:7191/api/ChargingStation/Add",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(stationDto),
                    success: function (response) {
                        showSuccessToast("Thêm trạm sạc thành công!");
                        setTimeout(function () {
                            window.location.href = "/wireless-charging/chargingstation/stationlist";
                        }, 1000);
                    },
                    error: function (xhr) {
                        console.error("Lỗi khi thêm trạm sạc:", xhr.responseText);
                        alert("Thêm trạm sạc thất bại!");
                    }
                });
            });

            $.ajax({
                url: "https://localhost:7191/api/User?roleId=2&pageNumber=1&pageSize=10",
                type: "GET",
                success: function (data) {
                    const ownerSelect = $("#owner");
                    ownerSelect.empty(); // Xoá các option cũ
                    ownerSelect.append(`<option selected disabled>Chọn chủ sở hữu</option>`);

                    data.data.forEach(user => {
                        ownerSelect.append(`
                            <option value="${user.userId}">${user.fullname}</option>
                        `);
                    });
                },
                error: function (xhr) {
                    console.error("Lỗi khi lấy danh sách user:", xhr.responseText);
                    $("#owner").html(`<option disabled selected>Không thể tải danh sách chủ sở hữu</option>`);
                }
            });
        });

    </script>

</body>
</html>