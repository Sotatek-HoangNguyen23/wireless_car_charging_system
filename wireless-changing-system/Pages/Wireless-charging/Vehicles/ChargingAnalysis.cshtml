@page
@model wireless_changing_system.Pages.Wireless_charging.Vehicles.ChargingAnalysisModel
@{
    <div class="container py-4">
        <!-- Header Section -->
        <div class="d-flex align-items-center mb-4">
            <h1 class="mb-0 text-black">Theo dõi sạc</h1>
            <div class="mx-5 d-flex align-items-center">
                <h3 id="noti" class="me-3 mb-0"></h3> <!-- Thêm mb-0 để tránh margin mặc định -->
                <button id="retry-btn" class="btn btn-primary d-none">Xem lịch sử sạc</button>
            </div>
        </div>


        <!-- Main Card -->
        <div class="card shadow-lg">
            <div class="card-body">
                <!-- Vehicle Info Section -->
                <div class="row align-items-center mb-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h2 class="text-black mb-0">
                                <i class="bi bi-car-front me-2"></i>VF 9 Eco
                                <span class="badge bg-success ms-2" id="status">Đang cập nhật...</span>
                            </h2>
                            <div class="license-plate px-3 py-1 rounded fs-5">
                                Biển số xe: <br />
                                <span class="fw-bold">301 - 567.89</span>
                            </div>
                        </div>

                        <div class="battery-status mb-4 d-flex flex-column ">
                            <!-- Căn giữa theo chiều dọc -->
                            <div class="d-flex align-items-center mb-2 text-black">
                                <!-- Căn icon và text theo chiều dọc -->
                                <i class="bi bi-battery-charging me-2 fs-1"></i>
                                <span>% Pin hiện tại</span>
                            </div>
                            <div class="progress" style="height: 25px; width: 80%;">
                                <div class="progress-bar" id="battery-progress"
                                     role="progressbar" style="width: 0%"
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    Đang cập nhật...
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-6">
                        <div class="station-info">
                            <h3 class="text-black mb-3">
                                <i class="bi bi-ev-station me-2 text-primary"></i>
                                <span id="station-name">Đang cập nhật...</span>
                            </h3>
                            <div class="address-card bg-light p-3 rounded">
                                <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                                <span class="text-secondary" id="station-address">Đang cập nhật...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics Grid -->
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card p-3 bg-light rounded">
                            <i class="bi bi-lightning-charge fs-1 text-warning mb-2"></i>
                            <h5 class="text-muted">Công suất</h5>
                            <h2 class="text-black" id="charging-power">Đang cập nhật...</h2>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card p-3 bg-light rounded">
                            <i class="bi bi-thermometer-sun fs-1 text-danger mb-2"></i>
                            <h5 class="text-muted">Nhiệt độ</h5>
                            <h2 class="text-black" id="temperature">Đang cập nhật...</h2>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card p-3 bg-light rounded">
                            <i class="bi bi-speedometer2 fs-1 text-primary mb-2"></i>
                            <h5 class="text-muted">Dòng điện</h5>
                            <h2 class="text-black" id="current">Đang cập nhật...</h2>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-card p-3 bg-light rounded">
                            <i class="bi bi-cash-coin fs-1 text-success mb-2"></i>
                            <h5 class="text-muted">Giá tiền</h5>
                            <h2 class="text-black" id="cost">Đang cập nhật...</h2>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center mt-3">
                    <button class="btn btn-primary">Xem chi tiết</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        // Kết nối SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:7191/realtimeHub")
            .build();

        connection.start().then(() => {
            console.log("Connected to SignalR hub");
        }).catch(err => console.error("SignalR error:", err));

        // Xử lý reconnect nếu mất kết nối
        connection.onclose(async () => {
            console.warn("Mất kết nối SignalR. Đang thử kết nối lại...");
            setTimeout(() => {
                connection.start().catch(err => console.error("Lỗi khi kết nối lại:", err));
            }, 5000);
        });

        // Khi nhận thông báo thay đổi từ database
        connection.on("ReceiveUpdate", (message) => {
            console.log("Database changed:", message);
            updateChargingData(); // Gọi lại API để cập nhật UI
        });

        async function updateChargingData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const carId = urlParams.get('carId');

                if (!carId) {
                    console.error("Không tìm thấy carId trong URL.");
                    return;
                }

                const response = await fetch(`https://localhost:7191/api/Car/real-time-status/${carId}`);
                if (!response.ok) throw new Error(`Lỗi API: ${response.status} - ${response.statusText}`);

                const data = await response.json();
                if (!data) throw new Error("Dữ liệu API không hợp lệ.");

                // Cập nhật UI
                document.getElementById('status').textContent = data.status === "Charging" ? "Đang sạc" : (data.status || "Không xác định");
                document.getElementById('station-name').textContent = data.stationName || "Chưa có dữ liệu";
                document.getElementById('station-address').textContent = data.address || "Chưa có dữ liệu";
                document.getElementById('charging-power').textContent = `${data.chargingPower || 0}W`;
                document.getElementById('temperature').textContent = `${data.temperature || 0}°C`;
                 document.getElementById('current').textContent = `${data.current || 0}A`;
                document.getElementById('cost').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format((data.cost || 0) * 1000);

                // Cập nhật mức pin
                const batteryPercent = Math.round(data.batteryLevel || 0);
                const batteryProgress = document.getElementById('battery-progress');
                batteryProgress.style.width = `${batteryPercent}%`;
                batteryProgress.textContent = `${batteryPercent}%`;

                // Đổi màu thanh pin theo mức sạc
                batteryProgress.className = "progress-bar";
                if (batteryPercent <= 20) batteryProgress.classList.add("bg-danger");
                else if (batteryPercent <= 40) batteryProgress.classList.add("bg-warning");
                else if (batteryPercent <= 60) batteryProgress.classList.add("bg-yellow");
                else if (batteryPercent <= 80) batteryProgress.classList.add("bg-success");
                else batteryProgress.classList.add("bg-success");

            } catch (error) {
                    console.error('Lỗi khi cập nhật dữ liệu:', error);
                document.getElementById('status').textContent = "OFFLINE!";
                document.getElementById('status').classList.remove('bg-success');
                document.getElementById('status').classList.add('bg-secondary');

                document.getElementById('noti').textContent = "Phiên sạc đã hoàn thành!";
               

                // Hiển thị button và thêm sự kiện redirect
                        const retryBtn = document.getElementById('retry-btn');
        retryBtn.classList.remove('d-none');
        retryBtn.onclick = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const carId = urlParams.get('carId');

            if (carId) {
                window.location.href = `https://localhost:5216/wireless-charging/vehicles/charginghistory?carId=${carId}`;
            } else {
                console.error("Không tìm thấy carId, không thể chuyển hướng!");
            }
        };
            }
        }

        updateChargingData(); // Tải dữ liệu ban đầu
    </script>

    <style>
        .metric-card { transition: transform 0.3s ease; border: 1px solid #dee2e6; }
        .metric-card:hover { transform: translateY(-5px); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .station-info {  padding-left: 1.5rem; }
    </style>
}